<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-auth.js"></script>

    <style>
        /* Your CSS styles here */
        #studentListContainer {
            display: flex;
            flex-direction: column;
            max-width: 200px;
            border-right: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            height: calc(100vh - 20px);
        }
        #chatContainer {
            display: none; /* Initially hidden */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: calc(100vh - 20px);
            padding: 20px;
        }
        #chatMessages {
            overflow-y: auto;
            max-height: 70vh;
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }
        #messageInput {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
        }
        button {
            padding: 10px 20px;
            cursor: pointer;
            margin-top: 10px;
        }
        #fileList {
            list-style-type: none;
            padding: 0;
        }
        .file, .folder {
            background-color: #6f4f9d;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .folder:hover, .file:hover {
            background-color: #8773d4;
        }
        .file-options span {
            margin-left: 10px;
            cursor: pointer;
            color: #ffffff;
        }
        .file-options span:hover {
            text-decoration: underline;
        }
        .refresh-button {
            background: none;
            border: none;
            color: #ffffff;
            cursor: pointer;
            font-size: 1.5em;
            margin-left: 10px;
            vertical-align: middle;
        }
        .refresh-button:hover {
            color: #6f4f9d;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #6f4f9d;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #d1c4e9;
        }
        h1 {
            color: #ffffff;
        }
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }
        .card {
            flex: 1 1 300px;
            background-color: #d1c4e9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(149, 136, 225, 0.5);
        }
        .card h2 {
            margin-top: 0;
            font-size: 1.5rem;
        }
        .student-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .student-button {
            padding: 10px 20px;
            background-color: #6f4f9d;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .student-button:hover {
            background-color: #0056b3;
        }
        .student-details {
            margin-right: 10px;
        }
        .student-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .class-info {
            margin-top: 20px;
        }
        .class-info input[type="date"],
        .class-info input[type="text"] {
            padding: 8px;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        .class-info button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }
        .class-info button:hover {
            background-color: #45a049;
        }
        .class-info p {
            font-size: 1rem;
            margin-top: 10px;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #6f4f9d;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #fff;
        }
        .path {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .hidden {
            display: none;
        }

        #chatContainer {
            display: flex;
            flex-direction: column;
            height: 400px;
            border-top: 1px solid #ddd;
            margin-top: 10px;
            padding-top: 10px;
        }

        #chatHeader {
            display: flex;
            justify-content: flex-end;
        }

        #chatMessages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #d1c4e9;
            color: #000000;
        }

        #chatMessages div {
            margin-bottom: 5px;
        }

        #chatForm {
            display: flex;
        }

        #chatForm input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px 0 0 5px;
        }

        #chatForm button {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #6f4f9d;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        .student-list {
            margin-bottom: 20px;
        }

        .student-item {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .student-item:hover {
            background-color: #f9f9f9;
        }

        .chat-box {
            display: none;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 20px;
        }

        .chat-box.active {
            display: block;
        }

        #chatMessages {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        #chatHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        #messageInput {
            width: calc(100% - 70px);
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #closeChat {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
        }

        #closeChat:hover {
            background-color: #c82333;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 10px;
            overflow-y: auto; /* Enable vertical scrolling */
        }

        .chat-messages {
            margin-bottom: 10px;
        }

        .message {
            max-width: 70%;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .teacher-message {
            align-self: flex-end;
            background-color: #00394f;
        }

        .student-message {
            align-self: flex-start;
            background-color: #8773d4;
        }

        .message-sender {
            font-weight: bold;
            margin-right: 5px;
        }

        .message-timestamp {
            font-size: 0.8em;
            margin-left: 10px;
            color: #888888;
        }
        .chat-container {
            max-width: 600px; /* Adjust the max-width as per your design requirements */
            margin: 20px auto; /* Center align the chat container and provide margin */
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .chat-messages {
            max-height: 400px; /* Limit the height of the chat messages container */
            overflow-y: auto; /* Enable vertical scrolling for overflow */
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .chat-input {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .chat-input textarea {
            flex: 1;
            resize: none;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .chat-input button {
            margin-left: 10px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
        }

        .teacher-message {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
        }

        .student-message {
            background-color: #f0f0f0;
            color: #333;
            align-self: flex-start;
        }

        .message-sender {
            font-weight: bold;
            margin-right: 5px;
        }

        .message-text {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message-timestamp {
            font-size: 12px;
            color: #999;
            margin-left: 10px;
        }

        .container {
            display: flex;
            max-width: 1000px; /* Adjust as needed */
            margin: 20px auto;
            padding: 20px;
            background-color: #6f4f9d;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar {
            flex: 0 0 30%; /* Sidebar takes 30% of container width */
            margin-right: 20px;
        }

        .main-content {
            flex: 1; /* Main content takes remaining space */
        }

        .card {
            background-color: #6f4f9d;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .chat-container {
            max-width: 100%; /* Chat container can expand to fit main content */
            background-color: #d1c4e9;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

    </style>
</head>
<body>
<h1>Teacher Dashboard</h1>
<div class="dashboard">
    <!-- Current Classes Card -->
    <div class="card">
        <h2>Current Classes</h2>
        <div id="classList"></div>
    </div>

    <!-- Current Students Card -->
    <!-- Existing student list (already present) -->
    <div class="container">
        <div class="sidebar">
            <!-- Current Students UI (buttons to open chat) -->
            <div class="card">
                <h2>Current Students</h2>
                <div id="studentList" class="student-list">
                    <!-- Student buttons will be appended here -->
                </div>
            </div>
        </div>
        <div class="main-content">
            <!-- Chat UI will be dynamically loaded here -->
        </div>
    </div>










    <!-- Class Information Card -->
    <div class="card class-info">
        <h2>Class Information</h2>
        <form id="classInfoForm">
            <label for="className">Class Name:</label>
            <input type="text" id="className" name="className" readonly>

            <label for="classDate">Next Class Date:</label>
            <input type="date" id="classDate" name="classDate">

            <label for="classTimezone">Next Class Timing/Timezone:</label>
            <input type="text" id="classTimezone" name="classTimezone">

            <label for="meetingLink">Meeting Link:</label>
            <input type="text" id="meetingLink" name="meetingLink">

            <button type="submit">Update Class Information</button>
        </form>
        <p id="classDetails"></p>
    </div>
    <div class="card">
        <h2>Create Assignment</h2>
        <form id="createAssignmentForm">
            <div class="form-group">
                <label for="user-email">User Email:</label>
                <input type="email" id="user-email" required>
            </div>
            <div class="form-group">
                <label for="assignment-title">Title:</label>
                <input type="text" id="assignment-title" required>
            </div>
            <div class="form-group">
                <label for="assignment-details">Details:</label>
                <textarea id="assignment-details" required></textarea>
            </div>
            <div class="form-group">
                <label for="assignment-class">Class:</label>
                <input type="text" id="assignment-class" required>
            </div>
            <button type="submit">Create Assignment</button>
        </form>
    </div>
</div>
<div class="card">
    <h1>Students File Manager</h1>
    <h2>File Manager
        <button class="refresh-button" onclick="displayFileList()">
            &#x21bb;
        </button>
    </h2>
    <div id="path"></div>
    <ul id="fileList"></ul>
    <button onclick="addFolder()">Add Folder</button>
</div>
<!-- Upload Class Notes/Worksheets Card -->
<div class="card">
    <h2>Upload Class Notes/Worksheets</h2>
    <form id="uploadNotesForm">
        <div class="form-group">
            <label for="studentEmails">Student Emails (comma separated):</label>
            <input type="text" id="studentEmails" required>
        </div>
        <div class="form-group">
            <label for="notesFile">Upload File:</label>
            <input type="file" id="notesFile" required>
        </div>
        <button type="submit">Upload</button>
    </form>
</div>

<!-- View Existing Notes Card -->
<div class="card">
    <h2>View Given Notes</h2>
    <div id="notesList"></div>
</div>

<!-- Firebase Initialization -->
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBdoEiHLAyKqAkIUuFX7QSZ-QKVgEJ-k-g",
        authDomain: "terrahub-75dbf.firebaseapp.com",
        databaseURL: "https://terrahub-75dbf-default-rtdb.firebaseio.com",
        projectId: "terrahub-75dbf",
        storageBucket: "terrahub-75dbf.appspot.com",
        messagingSenderId: "468040062461",
        appId: "1:468040062461:web:0d48f044d4b484852b3594",
        measurementId: "G-EZ6B6H3MQ5"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const userEmail = sessionStorage.getItem('userEmail');

    const storage = firebase.storage();
    const storageRef = storage.ref();
    const auth = firebase.auth();
    if (userEmail) {
        checkUserRole(userEmail);
    } else {
        console.error('User email not found in session storage.');
        window.location.href = 'error.html'; // Redirect to error page if userEmail is not found
    }

    async function checkUserRole(userEmail) {
        try {
            // Replace periods with commas in userEmail for Firebase path
            const userEmailFirebase = userEmail.replace(/\./g, ',');

            // Firebase reference for the user
            const userRef = database.ref(`users/${userEmailFirebase}`);

            // Retrieve user data
            const snapshot = await userRef.once('value');
            const userData = snapshot.val();

            if (userData && userData.tag) {
                // Check user role based on 'tag' value
                if (userData.tag === 'student') {
                    // If user is a student, block access
                    console.log('Access denied for students.');
                    window.location.href = 'access-denied.html'; // Redirect to access denied page
                } else if (userData.tag === 'teacher') {
                    // If user is a teacher, allow access
                    console.log('Access granted for teachers.');
                    // Proceed with loading the webpage or functionality
                }
            } else {
                // Handle case where 'tag' value is missing or undefined
                console.error('User data or tag value missing.');
                window.location.href = 'error.html'; // Redirect to error page
            }
        } catch (error) {
            console.error('Error checking user role:', error);
            window.location.href = 'error.html'; // Redirect to error page on error
        }
    }




    // Example usage:





    let currentPath = '';
    if (!userEmail) {
        alert('User not authenticated.');
        window.location.href = '/';
    }



    function displayFileList(path = '') {
        currentPath = path;
        const fileListElement = document.getElementById('fileList');
        fileListElement.innerHTML = '';

        const pathElement = document.getElementById('path');
        pathElement.innerHTML = '';

        if (currentPath) {
            const folders = currentPath.split('/').filter(Boolean);
            let tempPath = '';
            for (const folder of folders) {
                tempPath += `${folder}/`;
                const span = document.createElement('span');
                span.textContent = folder;
                span.onclick = () => {
                    displayFileList(tempPath);
                };
                pathElement.appendChild(span);
                pathElement.innerHTML += ' / ';
            }
        }

        const currentRef = path ? storageRef.child(path) : storageRef;

        currentRef.listAll().then((result) => {
            result.prefixes.forEach((folderRef) => {
                const folderName = folderRef.name.split('/').filter(Boolean).pop();
                const listItem = document.createElement('li');
                listItem.className = 'folder';
                listItem.innerHTML = `
                    <span class="material-icons icon">folder</span>
                    <span onclick="displayFileList('${folderRef.fullPath}')">${folderName}</span>
                `;
                fileListElement.appendChild(listItem);
            });

            result.items.forEach((itemRef) => {
                const itemName = itemRef.name.split('/').pop();

                if (itemName) {
                    const listItem = document.createElement('li');
                    listItem.className = 'file';
                    listItem.innerHTML = `
                        <span class="material-icons icon">insert_drive_file</span>
                        <span>${itemName}</span>
                        <span class="file-options">
                            <span onclick="downloadFile('${itemRef.fullPath}')">Download</span>
                            <span onclick="renameFile('${itemRef.fullPath}')">Rename</span>
                            <span onclick="deleteFile('${itemRef.fullPath}')">Delete</span>
                        </span>
                    `;
                    fileListElement.appendChild(listItem);
                }
            });
        });
    }

    function addFile(folderPath) {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            const fileName = file.name;
            const fileRef = storageRef.child(`${folderPath}/${fileName}`);
            fileRef.put(file).then(() => {
                displayFileList(folderPath);
            }).catch((error) => {
                console.error('Upload failed:', error.message);
            });
        });
        fileInput.click();
    }

    function addFolder() {
        const folderName = prompt('Enter new folder name:');
        if (folderName) {
            const folderPath = currentPath ? `${currentPath}${folderName}/.folderMarker_${Date.now()}` : `${folderName}/.folderMarker_${Date.now()}`;
            storageRef.child(folderPath).put(new Blob(['folderMarker']))
                .then(() => {
                    console.log('Folder created:', folderPath);
                    displayFileList(currentPath);
                })
                .catch((error) => {
                    console.error('Folder creation failed:', error.message);
                });
        }
    }

    function deleteFolder(folderPath) {
        const folderRef = storageRef.child(folderPath);
        folderRef.delete().then(() => {
            displayFileList(currentPath);
        }).catch((error) => {
            console.error('Folder deletion failed:', error.message);
        });
    }

    function deleteFile(filePath) {
        const fileRef = storageRef.child(filePath);
        fileRef.delete().then(() => {
            displayFileList(currentPath);
        }).catch((error) => {
            console.error('File deletion failed:', error.message);
        });
    }

    function downloadFile(filePath) {
        const fileRef = storageRef.child(filePath);
        fileRef.getDownloadURL().then((url) => {
            const a = document.createElement('a');
            a.href = url;
            a.download = filePath.split('/').pop();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }).catch((error) => {
            console.error('Download failed:', error.message);
        });
    }

    function navigateToPath(path) {
        displayFileList(path);
    }

    function renameFolder(folderPath) {
        const newFolderName = prompt('Enter new folder name:');
        if (newFolderName) {
            const folderRef = storageRef.child(folderPath);
            const parentPath = folderPath.substring(0, folderPath.lastIndexOf('/') + 1);
            const newFolderPath = parentPath + newFolderName + '/';

            folderRef.listAll()
                .then((result) => {
                    const promises = [];
                    result.items.forEach((item) => {
                        const newItemPath = newFolderPath + item.name.split('/').pop();
                        promises.push(item.move(newItemPath));
                    });

                    Promise.all(promises)
                        .then(() => {
                            console.log('Folder renamed:', folderPath, 'to', newFolderPath);
                            displayFileList(currentPath);
                        })
                        .catch((error) => {
                            console.error('Folder renaming failed:', error.message);
                        });
                })
                .catch((error) => {
                    console.error('Error listing folder items:', error.message);
                });
        }
    }

    function renameFile(filePath) {
        const newFileName = prompt('Enter new file name:');
        if (newFileName) {
            const fileRef = storageRef.child(filePath);
            const parentPath = filePath.substring(0, filePath.lastIndexOf('/') + 1);
            const newFilePath = parentPath + newFileName;

            fileRef.getDownloadURL()
                .then((url) => {
                    const xhr = new XMLHttpRequest();
                    xhr.responseType = 'blob';
                    xhr.onload = () => {
                        const newFileRef = storageRef.child(newFilePath);
                        newFileRef.put(xhr.response)
                            .then(() => {
                                console.log('File renamed:', filePath, 'to', newFilePath);
                                fileRef.delete()
                                    .then(() => {
                                        displayFileList(currentPath);
                                    })
                                    .catch((error) => {
                                        console.error('Error deleting old file:', error.message);
                                    });
                            })
                            .catch((error) => {
                                console.error('Error uploading renamed file:', error.message);
                            });
                    };
                    xhr.open('GET', url);
                    xhr.send();
                })
                .catch((error) => {
                    console.error('Error fetching file:', error.message);
                });
        }
    }


    function loadTeacherClasses() {
        const encodedEmail = encodeEmail(userEmail);
        const classList = document.getElementById('classList');
        classList.innerHTML = '';

        database.ref(`users/${encodedEmail}/classes`).once('value', snapshot => {
            snapshot.forEach(classSnapshot => {
                const classData = classSnapshot.val();
                const classButton = document.createElement('button');
                classButton.textContent = classData.className;
                classButton.classList.add('class-button');
                classButton.onclick = () => {
                    showClassInformation(classData, classSnapshot.key); // Pass the class key
                };
                classList.appendChild(classButton);
            });
        });
    }

    function createAssignment() {
        const userEmail = document.getElementById('user-email').value.replace(/\./g, ',');
        const title = document.getElementById('assignment-title').value;
        const details = document.getElementById('assignment-details').value;
        const className = document.getElementById('assignment-class').value;

        if (userEmail && title && details && className) {
            const assignmentId = database.ref().child('users/' + userEmail + '/assignments').push().key;

            const assignmentData = {
                title: title,
                details: details,
                class: className,
                uploaded: false
            };

            const updates = {};
            updates['/users/' + userEmail + '/assignments/' + assignmentId] = assignmentData;

            database.ref().update(updates).then(() => {
                alert('Assignment created successfully!');
            }).catch((error) => {
                console.error('Error creating assignment:', error);
                alert('Error creating assignment: ' + error.message);
            });
        } else {
            alert('Please fill out all fields.');
        }
    }

    document.getElementById('createAssignmentForm').addEventListener('submit', (event) => {
        event.preventDefault();
        createAssignment();
    });

    // Function to load current students


    // Helper function to fetch classes for a given userEmail
    async function fetchUserClassesByEmail(userEmail) {
        const currentUserClasses = [];

        try {
            const snapshot = await database.ref('users').once('value');
            snapshot.forEach(userSnapshot => {
                const userData = userSnapshot.val();
                if (userData.email === userEmail && userData.classes) {
                    Object.values(userData.classes).forEach(classInfo => {
                        if (classInfo.className) {
                            currentUserClasses.push(classInfo.className);
                        }
                    });
                }
            });
        } catch (error) {
            console.error('Error fetching user classes:', error);
        }

        return currentUserClasses;
    }

    // Helper function to find common classes among all users
    async function findCommonClasses(currentUserClasses) {
        const commonClasses = {};

        try {
            const snapshot = await database.ref('users').once('value');
            snapshot.forEach(userSnapshot => {
                const userData = userSnapshot.val();
                if (userData.tag === 'student' && userData.classes) {
                    Object.keys(userData.classes).forEach(encodedValue => {
                        const studentClasses = userData.classes[encodedValue];
                        Object.values(studentClasses).forEach(classInfo => {
                            if (classInfo.className && currentUserClasses.includes(classInfo.className)) {
                                if (!commonClasses[classInfo.className]) {
                                    commonClasses[classInfo.className] = [];
                                }
                                commonClasses[classInfo.className].push(userData.email);
                            }
                        });
                    });
                }
            });
        } catch (error) {
            console.error('Error finding common classes:', error);
        }

        return commonClasses;
    }

    // Helper function to display common classes on the UI
    function displayCommonClasses(studentList, commonClasses, teacherEmail) {
        Object.keys(commonClasses).forEach(className => {
            const emails = commonClasses[className];
            emails.forEach(email => {
                const studentButton = document.createElement('button');
                studentButton.className = 'student-button';
                studentButton.innerHTML = `
                <span class="student-details">${email}</span>
                <span class="common-class">${className}</span>
            `;
                studentButton.onclick = () => {
                    showChatWithStudent(email); // Open chat with this student
                };
                studentList.appendChild(studentButton);
            });
        });
    }
    async function loadCurrentStudents() {
        const studentList = document.getElementById('studentList');
        studentList.innerHTML = '';

        try {
            // Retrieve userEmail from session storage and adjust format
            let userEmail = sessionStorage.getItem('userEmail');
            userEmail = userEmail.replace(/\./g, ',');

            console.log('User Email from session storage:', userEmail);

            // Step 1: Fetch current user's classes
            const currentUserClasses = [];

            const snapshotCurrentUser = await database.ref(`users/${userEmail}/classes`).once('value');

            snapshotCurrentUser.forEach(encodedValueSnapshot => {
                const encodedValue = encodedValueSnapshot.key;
                const classInfo = encodedValueSnapshot.val();
                if (classInfo.className) {
                    currentUserClasses.push(classInfo.className);
                }
            });

            console.log('Current User Classes:', currentUserClasses);

            // Step 2: Fetch other users' classes and find common classNames
            const commonClasses = {};

            const snapshotUsers = await database.ref('users').once('value');

            snapshotUsers.forEach(userSnapshot => {
                const userData = userSnapshot.val();
                const userEmailWithPeriod = userSnapshot.key.replace(/,/g, '.'); // Convert email back to period format

                if (userData.tag === 'student' && userSnapshot.key !== userEmail && userData.classes) {
                    Object.keys(userData.classes).forEach(encodedValue => {
                        const classInfo = userData.classes[encodedValue];
                        if (classInfo.className && currentUserClasses.includes(classInfo.className)) {
                            if (!commonClasses[classInfo.className]) {
                                commonClasses[classInfo.className] = [];
                            }
                            if (!commonClasses[classInfo.className].includes(userEmailWithPeriod)) {
                                commonClasses[classInfo.className].push(userEmailWithPeriod);
                            }
                        }
                    });
                }
            });

            console.log('Common Classes:', commonClasses);

            // Step 3: Display common classes and associated email addresses
            Object.keys(commonClasses).forEach(className => {
                const emails = commonClasses[className];
                emails.forEach(email => {
                    const studentButton = document.createElement('button');
                    studentButton.className = 'student-button';
                    studentButton.innerHTML = `
                    <span class="student-details">${email}</span>
                    <span class="common-class">${className}</span>
                `;
                    studentButton.onclick = () => {
                        showChatWithStudent(email); // Open chat with this student
                    };
                    studentList.appendChild(studentButton);
                });
            });

        } catch (error) {
            console.error('Error fetching and displaying students:', error);
        }
    }
    // Function to load chat interface with a specific student
    // Function to load chat interface with a specific student
    // Function to load chat interface with a specific student
    // Function to load chat interface with a specific student
    // Function to load chat interface with a specific student
    async function loadChatWithStudent(studentEmail, studentName) {
        const mainContent = document.querySelector('.main-content');
        mainContent.innerHTML = ''; // Clear previous content

        const chatContainer = document.createElement('div');
        chatContainer.className = 'chat-container';

        chatContainer.innerHTML = `
        <div class="chat-header">
            <span id="chatTitle">Chat with ${studentName} (${studentEmail})</span>
            <button id="refreshButton" title="Refresh Chat"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input">
            <textarea id="messageInput" placeholder="Type your message..."></textarea>
            <button id="sendButton">Send</button>
        </div>
    `;

        mainContent.appendChild(chatContainer);

        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const refreshButton = document.getElementById('refreshButton');

        // Convert emails to Firebase-compatible format (replace commas with periods)
        const teacherEmailFirebase = userEmail.replace(/\./g, ',');

        // Replace commas with periods in studentEmail for Firebase path
        const studentEmailFirebase = studentEmail.replace(/\./g, ',');

        // Firebase reference for the chat
        const chatRef = database.ref(`chats/${teacherEmailFirebase}/${studentEmailFirebase}`);

        // Function to display a message in the chat
        function displayMessage(message) {
            const { sender, text, timestamp } = message;
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            if (sender === 'teacher') {
                messageElement.classList.add('teacher-message');
            } else {
                messageElement.classList.add('student-message');
            }
            messageElement.innerHTML = `
            <span class="message-sender">${sender === 'teacher' ? 'You' : studentName}</span>
            <span class="message-text">${text}</span>
            <span class="message-timestamp">${formatTimestamp(timestamp)}</span>
        `;
            chatMessages.appendChild(messageElement);
            // Scroll to bottom of chatMessages
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to format timestamp (optional)
        function formatTimestamp(timestamp) {
            // Implement formatting as needed
            return new Date(timestamp).toLocaleString();
        }

        // Event listener for sending a message
        sendButton.addEventListener('click', async () => {
            const messageText = messageInput.value.trim();
            if (messageText) {
                // Check if the message is duplicate by searching existing messages
                let isDuplicate = false;
                await chatRef.once('value', snapshot => {
                    snapshot.forEach(childSnapshot => {
                        const message = childSnapshot.val();
                        if (message.text === messageText && message.sender === 'teacher') {
                            isDuplicate = true;
                        }
                    });
                });

                if (!isDuplicate) {
                    const message = {
                        sender: 'teacher',
                        text: messageText,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    chatRef.push(message);
                } else {
                    console.log('Duplicate message detected. Not sending.');
                }

                messageInput.value = '';
            }
        });

        // Event listener for refreshing the chat
        refreshButton.addEventListener('click', () => {
            loadChatWithStudent(studentEmail, studentName); // Reload chat for the same student
        });

        // Retrieve and display existing messages
        chatRef.on('child_added', snapshot => {
            const message = snapshot.val();
            displayMessage(message);
        });
    }



    // Function to open chat with a student when button is clicked
    function showChatWithStudent(studentEmail) {
        // Fetch student name from DOM or another source if available
        const studentName = studentEmail.split('@')[0]; // Example: Extract name from email
        loadChatWithStudent(studentEmail, studentName);
    }


    // Function to show chat with a specific student
    // Function to show chat with a specific student

        // Function to encode email for Firebase path
    function encodeEmail(email) {
        return email.replace(/\./g, ',');
    }

    // Load students and classes on page load
    window.onload = async function() {
        loadTeacherClasses();
        await loadCurrentStudents();
    };


    function showClassInformation(classData, classKey) {
        const classNameInput = document.getElementById('className');
        const classDateInput = document.getElementById('classDate');
        const classTimezoneInput = document.getElementById('classTimezone');
        const meetingLinkInput = document.getElementById('meetingLink');
        const classDetails = document.getElementById('classDetails');

        classNameInput.value = classData.className;
        classDateInput.value = classData.classDate || '';
        classTimezoneInput.value = classData.classTimezone || '';
        meetingLinkInput.value = classData.meetingLink || '';

        const classInfoForm = document.getElementById('classInfoForm');
        classInfoForm.onsubmit = (event) => {
            event.preventDefault();
            const classDate = classDateInput.value;
            const classTimezone = classTimezoneInput.value;
            const meetingLink = meetingLinkInput.value;
            updateClassInformation(classKey, classData.className, classDate, classTimezone, meetingLink);
        };

        // Display class details
        classDetails.innerHTML = `
                <strong>Meeting Link:</strong> ${classData.meetingLink || 'N/A'}<br>
                <strong>Next Class Date:</strong> ${classData.classDate || 'N/A'}<br>
                <strong>Next Class Time/Zone:</strong> ${classData.classTimezone || 'N/A'}
            `;
    }

    function updateClassInformation(classKey, className, classDate, classTimezone, meetingLink) {
        const encodedEmail = encodeEmail(userEmail);

        // Update teacher's class information under existing className
        database.ref(`users/${encodedEmail}/classes/${classKey}`).update({
            classDate: classDate,
            classTimezone: classTimezone,
            meetingLink: meetingLink
        }).then(() => {
            alert('Class information updated successfully!');
        }).catch(error => {
            console.error('Error updating class information:', error);
        });
    }

    function teacherTeachesClass(teacherEmail, className) {
        const encodedTeacherEmail = encodeEmail(teacherEmail);
        const classRef = database.ref(`users/${encodedTeacherEmail}/classes`);
        return classRef.once('value').then(snapshot => {
            let teachesClass = false;
            snapshot.forEach(classSnapshot => {
                const classData = classSnapshot.val();
                if (classData.className === className) {
                    teachesClass = true;
                }
            });
            return teachesClass;
        }).catch(error => {
            console.error('Error checking teacher classes:', error);
            return false;
        });
    }

    function encodeEmail(email) {
        return email.replace(/\./g, ',');
    }

    function encodeClassName(className) {
        return className.replace(/[\s!@#$%^&*(),.?":{}|<>]/g, '');
    }

    window.onload = async function() {
        loadTeacherClasses();
        await loadCurrentStudents();
    };
    document.getElementById('uploadNotesForm').addEventListener('submit', (event) => {
        event.preventDefault();
        const studentEmails = document.getElementById('studentEmails').value.split(',').map(email => email.trim());
        const file = document.getElementById('notesFile').files[0];

        if (studentEmails.length > 0 && file) {
            const uploadPromises = studentEmails.map(email => {
                const fileRef = storage.ref(`${email}/notes/${file.name}`);
                return fileRef.put(file).then(() => {
                    console.log(`File uploaded successfully to ${email}`);
                }).catch((error) => {
                    console.error(`Upload failed for ${email}:`, error.message);
                });
            });

            Promise.all(uploadPromises).then(() => {
                alert('File uploaded successfully!');
                loadNotesList();
                document.getElementById('uploadNotesForm').reset();
            });
        } else {
            alert('Please enter student emails and select a file.');
        }
    });

    function loadNotesList() {
        const notesList = document.getElementById('notesList');
        notesList.innerHTML = '';

        database.ref('users').once('value').then(snapshot => {
            snapshot.forEach(userSnapshot => {
                const userData = userSnapshot.val();
                if (userData.tag === 'student') {
                    const studentEmail = userData.email;
                    const studentNotesRef = storage.ref(`${studentEmail}/notes`);

                    studentNotesRef.listAll().then((result) => {
                        if (result.items.length > 0) {
                            const studentNotesDiv = document.createElement('div');
                            studentNotesDiv.innerHTML = `<h3>Notes for ${studentEmail}</h3>`;
                            const notesUl = document.createElement('ul');

                            result.items.forEach((itemRef) => {
                                const noteLi = document.createElement('li');
                                itemRef.getDownloadURL().then((url) => {
                                    const downloadLink = document.createElement('a');
                                    downloadLink.href = url;
                                    downloadLink.textContent = itemRef.name;
                                    downloadLink.target = '_blank';
                                    noteLi.appendChild(downloadLink);
                                });
                                notesUl.appendChild(noteLi);
                            });

                            studentNotesDiv.appendChild(notesUl);
                            notesList.appendChild(studentNotesDiv);
                        }
                    }).catch((error) => {
                        console.error('Error loading notes:', error);
                    });
                }
            });
        }).catch((error) => {
            console.error('Error fetching users:', error);
        });
    }

    window.onload = function() {
        loadTeacherClasses();
        loadCurrentStudents();
        loadNotesList();
    };



</script>
</body>
</html>
